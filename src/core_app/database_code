-- Tạo database
CREATE DATABASE ECommerceDB;
GO

USE ECommerceDB;
GO

-- Bảng User
CREATE TABLE Users (
    user_id INT IDENTITY(1,1) PRIMARY KEY,
    username NVARCHAR(50) NOT NULL,
    email NVARCHAR(100) NOT NULL UNIQUE,
    password NVARCHAR(255) NOT NULL,
    phone NVARCHAR(15),
    address NVARCHAR(255)
);

-- Bảng Shop
CREATE TABLE Shops (
    shop_id INT IDENTITY(1,1) PRIMARY KEY,
    shop_name NVARCHAR(100) NOT NULL,
    owner_id INT NOT NULL,
    rating DECIMAL(3,2) DEFAULT 0,
    FOREIGN KEY (owner_id) REFERENCES Users(user_id)
);

-- Bảng Product
CREATE TABLE Products (
    product_id INT IDENTITY(1,1) PRIMARY KEY,
    shop_id INT NOT NULL,
    product_name NVARCHAR(100) NOT NULL,
    description NVARCHAR(500),
    price_base DECIMAL(10,2) NOT NULL,
    stock_total INT DEFAULT 0,
    FOREIGN KEY (shop_id) REFERENCES Shops(shop_id)
);

-- Bảng Product Variant
CREATE TABLE Product_Variants (
    variant_id INT IDENTITY(1,1) PRIMARY KEY,
    product_id INT NOT NULL,
    color NVARCHAR(50),
    size NVARCHAR(20),
    price DECIMAL(10,2) NOT NULL,
    stock INT DEFAULT 0,
    FOREIGN KEY (product_id) REFERENCES Products(product_id)
);

-- Bảng Order
CREATE TABLE Orders (
    order_id INT IDENTITY(1,1) PRIMARY KEY,
    user_id INT NOT NULL,
    order_date DATETIME DEFAULT GETDATE(),
    total_amount DECIMAL(10,2),
    status NVARCHAR(20) DEFAULT 'pending',
    FOREIGN KEY (user_id) REFERENCES Users(user_id)
);

-- Bảng Order Item
CREATE TABLE Order_Items (
    order_item_id INT IDENTITY(1,1) PRIMARY KEY,
    order_id INT NOT NULL,
    variant_id INT NOT NULL,
    quantity INT NOT NULL,
    price DECIMAL(10,2),
    FOREIGN KEY (order_id) REFERENCES Orders(order_id),
    FOREIGN KEY (variant_id) REFERENCES Product_Variants(variant_id)
);

-- Bảng Voucher
CREATE TABLE Vouchers (
    voucher_id INT IDENTITY(1,1) PRIMARY KEY,
    code NVARCHAR(20) UNIQUE NOT NULL,
    discount_percent DECIMAL(5,2),
    start_date DATE,
    end_date DATE,
    max_usage INT,
    used_count INT DEFAULT 0
);

-- Bảng Order Voucher (một đơn có thể dùng nhiều voucher)
CREATE TABLE Order_Vouchers (
    order_id INT NOT NULL,
    voucher_id INT NOT NULL,
    PRIMARY KEY (order_id, voucher_id),
    FOREIGN KEY (order_id) REFERENCES Orders(order_id),
    FOREIGN KEY (voucher_id) REFERENCES Vouchers(voucher_id)
);
-- Giả sử file CSV có các cột: ProductName, ShopID, Color, Size, Price, Stock
Use ECommerceDB
BULK INSERT Products
FROM 'D:\Download\Documents\ecommerce_data_10000.csv'
WITH (
    FIELDTERMINATOR = ',',
    ROWTERMINATOR = '\n',
    FIRSTROW = 2
);

-- Nếu muốn xử lý dữ liệu rác, có thể dùng staging table
CREATE TABLE Products_Staging (
    product_name NVARCHAR(100),
    shop_id INT,
    color NVARCHAR(50),
    size NVARCHAR(20),
    price DECIMAL(10,2),
    stock INT
);

BULK INSERT Products_Staging
FROM 'D:\Download\Documents\ecommerce_data_10000.csv'
WITH (
    FIELDTERMINATOR = ',',
    ROWTERMINATOR = '\n',
    FIRSTROW = 2
);

-- Loại bỏ dòng rác
DELETE FROM Products_Staging
WHERE product_name IS NULL OR price <= 0;

-- Chèn vào bảng chính
INSERT INTO Products (shop_id, product_name, price_base, stock_total)
SELECT DISTINCT shop_id, product_name, price, stock
FROM Products_Staging;

-- Chèn các variant
INSERT INTO Product_Variants (product_id, color, size, price, stock)
SELECT p.product_id, s.color, s.size, s.price, s.stock
FROM Products_Staging s
JOIN Products p ON s.product_name = p.product_name AND s.shop_id = p.shop_id;


