2.1. E-Commerce Simulation (Mô hình Shopee/Lazada)
Thực thể: User, Shop, Product (với nhiều biến thể Size/Màu), Order, Voucher.
Thách thức Web: Giao diện sàn thương mại điện tử, giỏ hàng (Session management), tính toán khuyến mãi chồng chéo.
Simulator: Giả lập "Flash Sale" - Tool bắn hàng nghìn request đặt hàng cùng lúc vào Tomcat, Server phải xử lý Transaction để không bị âm kho.
Thiết kế Database. Viết module Import CSV to DB. Xử lý dữ liệu rác, đảm bảo toàn vẹn dữ liệu khi Insert.
Phan Tich Flowchart, tao doan code database trong sql server
OK! Chúng ta sẽ làm theo từng bước, từ phân tích mô hình, thiết kế database, đến viết SQL Server code và tạo flowchart xử lý dữ liệu. Tôi sẽ giải thích chi tiết từng phần.

1. Phân tích thực thể (Entities) và quan hệ (Relationships)
Thực thể chính:

User

user_id (PK)

username

email

password

phone

address

Shop

shop_id (PK)

shop_name

owner_id (FK → User.user_id)

rating

Product

product_id (PK)

shop_id (FK → Shop.shop_id)

product_name

description

price_base

stock_total

Product_Variant (Size/Màu)

variant_id (PK)

product_id (FK → Product.product_id)

color

size

price

stock

Order

order_id (PK)

user_id (FK → User.user_id)

order_date

total_amount

status (pending, confirmed, shipped, completed, cancelled)

Order_Item

order_item_id (PK)

order_id (FK → Order.order_id)

variant_id (FK → Product_Variant.variant_id)

quantity

price

Voucher

voucher_id (PK)

code

discount_percent

start_date

end_date

max_usage

used_count

Order_Voucher

order_id (FK → Order.order_id)

voucher_id (FK → Voucher.voucher_id)
2. Flowchart xử lý Import CSV vào DB

Giả sử bạn có file CSV chứa Product:

Bắt đầu

Đọc CSV dòng đầu tiên

Kiểm tra dữ liệu rác

Nếu thiếu giá, tên, size hoặc màu → bỏ qua hoặc log

Kiểm tra product_id đã tồn tại?

Nếu chưa → Insert vào Product + Product_Variant

Nếu đã tồn tại → Update stock / giá

Lặp cho đến hết file

Kết thúc
[Start] --> [Read CSV Line] --> [Validate Data?] --No--> [Log & Skip] --> [Next Line]
                             |
                             Yes
                             v
                   [Check Product Exists?] --No--> [Insert Product + Variant]
                             |
                             Yes
                             v
                  [Update Stock & Price] --> [Next Line]
                             |
                          [End of File?] --No--> [Read CSV Line]
                             |
                             Yes
                             v
                           [End]
3. SQL Server – Tạo Database và Tables
-- Tạo database
CREATE DATABASE ECommerceDB;
GO

USE ECommerceDB;
GO

-- Bảng User
CREATE TABLE Users (
    user_id INT IDENTITY(1,1) PRIMARY KEY,
    username NVARCHAR(50) NOT NULL,
    email NVARCHAR(100) NOT NULL UNIQUE,
    password NVARCHAR(255) NOT NULL,
    phone NVARCHAR(15),
    address NVARCHAR(255)
);

-- Bảng Shop
CREATE TABLE Shops (
    shop_id INT IDENTITY(1,1) PRIMARY KEY,
    shop_name NVARCHAR(100) NOT NULL,
    owner_id INT NOT NULL,
    rating DECIMAL(3,2) DEFAULT 0,
    FOREIGN KEY (owner_id) REFERENCES Users(user_id)
);

-- Bảng Product
CREATE TABLE Products (
    product_id INT IDENTITY(1,1) PRIMARY KEY,
    shop_id INT NOT NULL,
    product_name NVARCHAR(100) NOT NULL,
    description NVARCHAR(500),
    price_base DECIMAL(10,2) NOT NULL,
    stock_total INT DEFAULT 0,
    FOREIGN KEY (shop_id) REFERENCES Shops(shop_id)
);

-- Bảng Product Variant
CREATE TABLE Product_Variants (
    variant_id INT IDENTITY(1,1) PRIMARY KEY,
    product_id INT NOT NULL,
    color NVARCHAR(50),
    size NVARCHAR(20),
    price DECIMAL(10,2) NOT NULL,
    stock INT DEFAULT 0,
    FOREIGN KEY (product_id) REFERENCES Products(product_id)
);

-- Bảng Order
CREATE TABLE Orders (
    order_id INT IDENTITY(1,1) PRIMARY KEY,
    user_id INT NOT NULL,
    order_date DATETIME DEFAULT GETDATE(),
    total_amount DECIMAL(10,2),
    status NVARCHAR(20) DEFAULT 'pending',
    FOREIGN KEY (user_id) REFERENCES Users(user_id)
);

-- Bảng Order Item
CREATE TABLE Order_Items (
    order_item_id INT IDENTITY(1,1) PRIMARY KEY,
    order_id INT NOT NULL,
    variant_id INT NOT NULL,
    quantity INT NOT NULL,
    price DECIMAL(10,2),
    FOREIGN KEY (order_id) REFERENCES Orders(order_id),
    FOREIGN KEY (variant_id) REFERENCES Product_Variants(variant_id)
);

-- Bảng Voucher
CREATE TABLE Vouchers (
    voucher_id INT IDENTITY(1,1) PRIMARY KEY,
    code NVARCHAR(20) UNIQUE NOT NULL,
    discount_percent DECIMAL(5,2),
    start_date DATE,
    end_date DATE,
    max_usage INT,
    used_count INT DEFAULT 0
);

-- Bảng Order Voucher (một đơn có thể dùng nhiều voucher)
CREATE TABLE Order_Vouchers (
    order_id INT NOT NULL,
    voucher_id INT NOT NULL,
    PRIMARY KEY (order_id, voucher_id),
    FOREIGN KEY (order_id) REFERENCES Orders(order_id),
    FOREIGN KEY (voucher_id) REFERENCES Vouchers(voucher_id)
);
